name: Regenerate Dependabot Configuration

on:
  schedule:
    # Run every Monday at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  regenerate:
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Set up Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v6.0.0
        with:
          go-version-file: 'go.mod'

      - name: Regenerate dependabot.yml
        run: |
          echo "Regenerating .github/dependabot.yml..."
          ./hack/generate-dependabot.sh

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet .github/dependabot.yml; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in dependabot.yml"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in dependabot.yml"
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.CHATOPS_TOKEN }}
        run: |
          # Configure git
          git config user.name "Tekton Bot"
          git config user.email "tekton-bot@users.noreply.github.com"

          # Create a new branch
          BRANCH="dependabot-regen-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"

          # Commit changes
          git add .github/dependabot.yml
          git commit -m "Regenerate dependabot.yml from config

          This automated PR regenerates .github/dependabot.yml from
          .github/dependabot.config.yml to ensure the configuration
          is up-to-date with the latest release branches.

          Generated by: ${{ github.workflow }}
          Triggered by: ${{ github.event_name }}"

          # Push branch
          git push origin "$BRANCH"

          # Create PR
          gh pr create \
            --title "Regenerate dependabot.yml configuration" \
            --body "## Automated Dependabot Configuration Update

          This PR regenerates \`.github/dependabot.yml\` from \`.github/dependabot.config.yml\`.

          ### Changes
          The dependabot configuration has been regenerated to ensure it's in sync with:
          - Release branches listed in \`.github/dependabot.config.yml\`
          - Ecosystem configurations

          ### Review Checklist
          - [ ] Verify that all active LTS release branches are included
          - [ ] Check that main branch configurations look correct
          - [ ] Ensure patch-only restrictions are applied to release branches

          ---
          ðŸ¤– This PR was automatically created by the \`${{ github.workflow }}\` workflow.
          **Triggered by**: ${{ github.event_name }}
          **Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --base main \
            --head "$BRANCH" \
            --label "dependencies" \
            --label "kind/misc" \
            --label "release-note-none"

      - name: Summary
        run: |
          if [ "${{ steps.check-changes.outputs.changed }}" = "true" ]; then
            echo "âœ… Pull request created with updated dependabot.yml"
          else
            echo "âœ… No changes needed - dependabot.yml is up-to-date"
          fi
